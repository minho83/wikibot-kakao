<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LOD íŒŒí‹° ë¹ˆìë¦¬</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #0f1117;
    --card: #1a1d27;
    --card-hover: #222633;
    --border: #2a2e3d;
    --text: #e1e4ed;
    --text-dim: #8b90a0;
    --accent: #6c72cb;
    --warrior: #e74c3c;
    --warrior-bg: rgba(231,76,60,0.12);
    --rogue: #9b59b6;
    --rogue-bg: rgba(155,89,182,0.12);
    --mage: #3498db;
    --mage-bg: rgba(52,152,219,0.12);
    --cleric: #f1c40f;
    --cleric-bg: rgba(241,196,15,0.12);
    --taoist: #1abc9c;
    --taoist-bg: rgba(26,188,156,0.12);
    --empty: #e67e22;
    --complete: #27ae60;
  }

  body {
    font-family: 'Segoe UI', -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
  }

  .header {
    background: linear-gradient(135deg, #1a1d27 0%, #252a3a 100%);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(10px);
  }

  /* Row 1: Logo + Date + Actions */
  .header-row {
    max-width: 1200px;
    margin: 0 auto;
    padding: 12px 24px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  .logo-icon {
    width: 32px;
    height: 32px;
    background: linear-gradient(135deg, var(--accent), #cb69c1);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .logo h1 {
    font-size: 17px;
    font-weight: 700;
    letter-spacing: -0.5px;
  }

  .logo h1 span {
    color: var(--accent);
  }

  .header-center {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .date-nav {
    display: flex;
    align-items: center;
    gap: 2px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 3px;
  }

  .date-nav button {
    background: none;
    border: none;
    color: var(--text-dim);
    cursor: pointer;
    padding: 5px 10px;
    border-radius: 7px;
    font-size: 13px;
    transition: all 0.15s;
  }

  .date-nav button:hover {
    background: var(--card-hover);
    color: var(--text);
  }

  .date-nav .date-display {
    font-size: 14px;
    font-weight: 600;
    padding: 5px 10px;
    min-width: 110px;
    text-align: center;
  }

  .header-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  /* Row 2: Filters - single row */
  .filter-bar {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 24px 12px;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .filter-label {
    font-size: 11px;
    color: var(--text-dim);
    font-weight: 600;
    flex-shrink: 0;
  }

  .filter-spacer {
    flex: 1;
  }

  .filter-select {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 13px;
    font-weight: 500;
    padding: 5px 10px;
    cursor: pointer;
    outline: none;
    transition: border-color 0.15s;
  }

  .filter-select:hover, .filter-select:focus {
    border-color: var(--accent);
  }

  .main {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }

  /* Time group */
  .time-group {
    margin-bottom: 32px;
  }

  .time-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
    padding-bottom: 8px;
    border-bottom: 1px solid var(--border);
  }

  .time-badge {
    background: linear-gradient(135deg, var(--accent), #cb69c1);
    color: #fff;
    font-size: 14px;
    font-weight: 700;
    padding: 6px 14px;
    border-radius: 8px;
    letter-spacing: 0.5px;
  }

  .time-count {
    font-size: 13px;
    color: var(--text-dim);
  }

  /* Party cards */
  .party-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 16px;
  }

  .party-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
  }

  .party-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(0,0,0,0.3);
  }

  .party-card.complete {
    opacity: 0.5;
  }

  .party-card.complete::after {
    content: '\uC644\uBE44';
    position: absolute;
    top: 12px;
    right: -28px;
    background: var(--complete);
    color: #fff;
    font-size: 10px;
    font-weight: 700;
    padding: 4px 32px;
    transform: rotate(45deg);
    letter-spacing: 1px;
  }

  .card-top {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 14px;
  }

  .card-location {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .location-icon {
    width: 32px;
    height: 32px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    background: rgba(108,114,203,0.15);
  }

  .location-name {
    font-weight: 700;
    font-size: 16px;
  }

  .party-name {
    font-size: 12px;
    color: var(--text-dim);
    margin-top: 2px;
  }

  .card-meta {
    text-align: right;
  }

  .card-sender {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }

  .card-updated {
    font-size: 11px;
    color: var(--text-dim);
    opacity: 0.6;
  }

  /* Vacancy summary */
  .vacancy-summary {
    display: flex;
    gap: 6px;
    margin-bottom: 14px;
    flex-wrap: wrap;
  }

  .vacancy-tag {
    font-size: 11px;
    font-weight: 600;
    padding: 3px 10px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .vacancy-tag.warrior { background: var(--warrior-bg); color: var(--warrior); }
  .vacancy-tag.rogue { background: var(--rogue-bg); color: var(--rogue); }
  .vacancy-tag.mage { background: var(--mage-bg); color: var(--mage); }
  .vacancy-tag.cleric { background: var(--cleric-bg); color: var(--cleric); }
  .vacancy-tag.taoist { background: var(--taoist-bg); color: var(--taoist); }

  /* Slot rows */
  .slot-rows {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .slot-row {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .slot-job {
    width: 36px;
    font-size: 12px;
    font-weight: 700;
    text-align: center;
    flex-shrink: 0;
  }

  .slot-job.warrior { color: var(--warrior); }
  .slot-job.rogue { color: var(--rogue); }
  .slot-job.mage { color: var(--mage); }
  .slot-job.cleric { color: var(--cleric); }
  .slot-job.taoist { color: var(--taoist); }

  .slot-list {
    display: flex;
    gap: 6px;
    flex-wrap: wrap;
    flex: 1;
  }

  .slot {
    padding: 4px 12px;
    border-radius: 6px;
    font-size: 12px;
    font-weight: 500;
    border: 1px solid;
    min-width: 60px;
    text-align: center;
  }

  .slot.filled {
    border-color: var(--border);
    background: rgba(255,255,255,0.03);
    color: var(--text-dim);
  }

  .slot.empty {
    border-style: dashed;
    animation: pulse-border 2s ease-in-out infinite;
  }

  .slot.empty.warrior { border-color: var(--warrior); color: var(--warrior); background: var(--warrior-bg); }
  .slot.empty.rogue { border-color: var(--rogue); color: var(--rogue); background: var(--rogue-bg); }
  .slot.empty.mage { border-color: var(--mage); color: var(--mage); background: var(--mage-bg); }
  .slot.empty.cleric { border-color: var(--cleric); color: var(--cleric); background: var(--cleric-bg); }
  .slot.empty.taoist { border-color: var(--taoist); color: var(--taoist); background: var(--taoist-bg); }

  @keyframes pulse-border {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Copy button */
  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    background: rgba(108,114,203,0.15);
    border: 1px solid var(--accent);
    color: var(--accent);
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .copy-btn:hover {
    background: var(--accent);
    color: #fff;
  }

  .copy-btn.copied {
    background: var(--complete);
    border-color: var(--complete);
    color: #fff;
  }

  .card-actions {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
  }

  .copy-hint {
    font-size: 11px;
    color: var(--text-dim);
    opacity: 0.6;
  }

  /* Template & search buttons */
  .template-btn {
    background: linear-gradient(135deg, var(--accent), #cb69c1);
    border: none;
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    padding: 5px 12px;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }

  .template-btn:hover { opacity: 0.85; transform: scale(1.03); }

  .template-btn.copied {
    background: var(--complete);
  }

  /* My party search */
  .my-search {
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .my-search input {
    width: 110px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 5px 10px;
    color: var(--text);
    font-size: 12px;
  }

  .my-search input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .my-search input::placeholder {
    color: var(--text-dim);
    opacity: 0.6;
  }

  .my-search-btn {
    background: var(--accent);
    border: none;
    color: #fff;
    font-size: 12px;
    font-weight: 600;
    padding: 5px 10px;
    border-radius: 8px;
    cursor: pointer;
    white-space: nowrap;
    transition: opacity 0.15s;
  }

  .my-search-btn:hover { opacity: 0.85; }

  .my-search-clear {
    background: none;
    border: 1px solid var(--border);
    color: var(--text-dim);
    font-size: 11px;
    padding: 5px 8px;
    border-radius: 8px;
    cursor: pointer;
    display: none;
  }

  .my-search-clear.show { display: block; }

  /* Highlight my party card */
  .party-card.my-party {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px var(--accent), 0 4px 16px rgba(108,114,203,0.25);
  }

  .party-card.my-party .slot.my-slot {
    background: rgba(108,114,203,0.2);
    border-color: var(--accent);
    color: var(--accent);
    font-weight: 700;
  }

  .my-party-badge {
    display: none;
    font-size: 10px;
    font-weight: 700;
    color: var(--accent);
    background: rgba(108,114,203,0.15);
    padding: 2px 8px;
    border-radius: 4px;
  }

  .party-card.my-party .my-party-badge {
    display: inline-block;
  }

  /* Requirements */
  .requirements {
    margin-top: 12px;
    padding-top: 10px;
    border-top: 1px solid var(--border);
  }

  .req-item {
    font-size: 11px;
    color: var(--text-dim);
    padding: 2px 0;
  }

  .req-item strong {
    color: var(--text);
  }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 80px 24px;
    color: var(--text-dim);
  }

  .empty-state-icon {
    font-size: 48px;
    margin-bottom: 16px;
    opacity: 0.3;
  }

  .empty-state h3 {
    font-size: 18px;
    margin-bottom: 8px;
    color: var(--text);
  }

  /* Auto refresh indicator */
  .refresh-bar {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    color: var(--text-dim);
  }

  .refresh-dot {
    width: 5px;
    height: 5px;
    border-radius: 50%;
    background: var(--complete);
    animation: blink 2s ease-in-out infinite;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Loading */
  .loading {
    text-align: center;
    padding: 60px;
  }

  .spinner {
    width: 36px;
    height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 16px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .include-complete-wrap {
    display: flex;
    align-items: center;
    gap: 4px;
    font-size: 11px;
    color: var(--text-dim);
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
  }

  .include-complete-wrap input {
    accent-color: var(--accent);
    width: 14px;
    height: 14px;
  }

  /* Server config bar */
  .server-bar {
    background: var(--card);
    border-bottom: 1px solid var(--border);
    padding: 8px 24px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }

  .server-bar label {
    color: var(--text-dim);
    white-space: nowrap;
  }

  .server-bar input {
    flex: 1;
    max-width: 360px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 5px 10px;
    color: var(--text);
    font-size: 13px;
    font-family: monospace;
  }

  .server-bar input:focus {
    outline: none;
    border-color: var(--accent);
  }

  .server-bar button {
    background: var(--accent);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 5px 14px;
    font-size: 13px;
    cursor: pointer;
    white-space: nowrap;
  }

  .server-bar button:hover { opacity: 0.85; }

  .server-status {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #555;
    flex-shrink: 0;
  }

  .server-status.ok { background: var(--complete); }
  .server-status.err { background: var(--warrior); }

  /* Notice bar */
  .notice-bar {
    background: linear-gradient(90deg, rgba(108,114,203,0.15), rgba(203,105,193,0.15));
    border-bottom: 1px solid var(--border);
    padding: 8px 24px;
    text-align: center;
    font-size: 13px;
    color: var(--text-dim);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .main { padding: 12px; }
    .party-grid { grid-template-columns: 1fr; }
    /* Header compact */
    .header-row { padding: 8px 12px; gap: 8px; }
    .logo { display: none; }
    .header-center { justify-content: flex-start; }
    .date-nav .date-display { font-size: 13px; padding: 4px 8px; min-width: 95px; }
    .date-nav button { padding: 4px 8px; font-size: 12px; }

    /* Filter bar */
    .filter-bar { padding: 0 12px 8px; gap: 6px; flex-wrap: wrap; }
    .filter-select { font-size: 12px; flex: 1; }
    .filter-spacer { display: none; }
    .filter-label { font-size: 10px; }

    /* Compact notice bar */
    .notice-bar { padding: 6px 12px; font-size: 11px; }

    /* Compact server bar */
    .server-bar { padding: 6px 12px; font-size: 12px; }

    /* Compact party cards */
    .party-card { padding: 14px; border-radius: 12px; }
    .location-name { font-size: 14px; }
    .location-icon { width: 28px; height: 28px; font-size: 14px; border-radius: 6px; }
    .card-sender { font-size: 14px; }
    .time-badge { font-size: 13px; padding: 4px 10px; }

    /* My search & template compact */
    .my-search { flex: 1; min-width: 0; }
    .my-search input { flex: 1; min-width: 0; width: auto; }
    .template-btn { font-size: 11px; padding: 4px 8px; }
  }
</style>
</head>
<body>

<div class="server-bar" id="serverBar">
  <div class="server-status" id="serverStatus"></div>
  <label>Server:</label>
  <input type="text" id="serverUrl" placeholder="http://ì„œë²„IP:3000" spellcheck="false">
  <button onclick="connectServer()">ì—°ê²°</button>
</div>

<div class="notice-bar">
  <span>ì •ë³´ì¶œì²˜ : ì–´ë‘ ì˜ì „ì„¤ ë‚˜ê²”íŒŒí‹° ì˜¤í”ˆí†¡ | ë°ì´í„° ìˆ˜ì§‘ìƒíƒœì— ë”°ë¼ ì˜¤ì°¨ê°€ ìˆìœ¼ë‹ˆ ì°¸ê³ ! | ì œì‘ì: ë°€ë–¡ë°€ë–¡</span>
</div>

<div class="header">
  <div class="header-row">
    <div class="logo">
      <div class="logo-icon">P</div>
      <h1>íŒŒí‹° <span>ë¹ˆìë¦¬</span></h1>
    </div>
    <div class="header-center">
      <div class="date-nav">
        <button onclick="changeDate(-1)" title="Previous day">&#9664;</button>
        <div class="date-display" id="dateDisplay"></div>
        <button onclick="changeDate(1)" title="Next day">&#9654;</button>
      </div>
    </div>
    <div class="header-actions">
      <label class="include-complete-wrap">
        <input type="checkbox" id="includeComplete" onchange="loadParties()">
        <span>ì™„ë¹„</span>
      </label>
      <div class="refresh-bar">
        <div class="refresh-dot"></div>
        <span id="refreshTimer">30s</span>
      </div>
    </div>
  </div>
  <div class="filter-bar">
    <span class="filter-label">ì§ì—…</span>
    <select class="filter-select" id="jobFilter" onchange="setFilter(this.value)"></select>
    <span class="filter-label">ì‹œê°„</span>
    <select class="filter-select" id="timeFilter" onchange="setTimeFilter(this.value)"></select>
    <div class="filter-spacer"></div>
    <div class="my-search">
      <input type="text" id="myNameInput" placeholder="ìºë¦­í„°ëª…" spellcheck="false">
      <button class="my-search-btn" onclick="searchMyParty()">ë‚´íŒŒí‹° ê²€ìƒ‰</button>
      <button class="my-search-clear" id="mySearchClear" onclick="clearMySearch()">âœ•</button>
    </div>
    <button class="template-btn" onclick="copyBlankTemplate(this)">ğŸ“ ê¸°ë³¸ì–‘ì‹ ë³µì‚¬</button>
  </div>
</div>

<div class="main">
  <div id="content">
    <div class="loading">
      <div class="spinner"></div>
      <div style="color: var(--text-dim);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    </div>
  </div>
</div>

<script>
// â”€â”€ Server URL management â”€â”€
let SERVER_URL = '';

function getServerUrl() {
  // 1. Query param: ?server=http://...
  const params = new URLSearchParams(location.search);
  const fromParam = params.get('server');
  if (fromParam) return fromParam.replace(/\/+$/, '');

  // 2. localStorage
  const saved = localStorage.getItem('partyServerUrl');
  if (saved) return saved.replace(/\/+$/, '');

  // 3. Same origin (when served from server itself)
  if (location.protocol !== 'file:') return '';

  return '';
}

function initServerUrl() {
  SERVER_URL = getServerUrl();
  const input = document.getElementById('serverUrl');
  input.value = SERVER_URL;

  // Hide bar if served from server itself
  if (!SERVER_URL && location.protocol !== 'file:') {
    document.getElementById('serverBar').style.display = 'none';
  }
}

function connectServer() {
  const input = document.getElementById('serverUrl');
  let url = input.value.trim().replace(/\/+$/, '');
  if (url && !url.startsWith('http')) url = 'http://' + url;
  SERVER_URL = url;
  localStorage.setItem('partyServerUrl', url);
  loadParties();
}

function apiUrl(path) {
  return SERVER_URL + path;
}

async function checkServerStatus() {
  const dot = document.getElementById('serverStatus');
  try {
    const resp = await fetch(apiUrl('/health'), { signal: AbortSignal.timeout(5000) });
    const data = await resp.json();
    dot.className = data.status === 'ok' ? 'server-status ok' : 'server-status err';
  } catch {
    dot.className = 'server-status err';
  }
}

const JOB_INFO = {
  warrior: { name: 'Warrior', kr: 'ì „ì‚¬', icon: '&#x2694;' },
  rogue:   { name: 'Rogue',   kr: 'ë„ì ', icon: '&#x1F5E1;' },
  mage:    { name: 'Mage',    kr: 'ë²•ì‚¬', icon: '&#x2728;' },
  cleric:  { name: 'Cleric',  kr: 'ì§ì', icon: '&#x2695;' },
  taoist:  { name: 'Taoist',  kr: 'ë„ê°€', icon: '&#x262F;' }
};

const LOCATION_ICONS = {
  'íƒ‘ì¸µ': '&#x1F3F0;', 'ìƒì¸µ': '&#x1F3DB;', 'ê³ ì¸µ': '&#x26F0;',
  'ì„¤ì›': '&#x2744;', 'í•„ë“œ': '&#x1F332;',
  'ë‚˜ê²”íƒ‘': '&#x1F5FC;', 'ë‚˜ê²”ë§': '&#x1F48D;'
};

let currentDate = new Date();
let currentFilter = '';
let currentTimeFilter = '';
let refreshInterval = null;
let refreshCountdown = 30;
let allParties = [];
let partyDataMap = {};
let mySearchName = '';

// Initialize to Korean time
(function initKoreanDate() {
  const koStr = new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' });
  currentDate = new Date(koStr);
  currentDate.setHours(0, 0, 0, 0);
})();

function formatDate(d) {
  const y = d.getFullYear();
  const m = String(d.getMonth() + 1).padStart(2, '0');
  const day = String(d.getDate()).padStart(2, '0');
  return `${y}-${m}-${day}`;
}

function formatDisplayDate(d) {
  const month = d.getMonth() + 1;
  const day = d.getDate();
  const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const dName = dayNames[d.getDay()];
  const koStr = new Date().toLocaleString('en-US', { timeZone: 'Asia/Seoul' });
  const today = new Date(koStr);
  today.setHours(0, 0, 0, 0);
  const isToday = d.getTime() === today.getTime();
  return `${month}/${day} (${dName})${isToday ? ' ì˜¤ëŠ˜' : ''}`;
}

function changeDate(delta) {
  currentDate.setDate(currentDate.getDate() + delta);
  updateDateDisplay();
  loadParties();
}

function updateDateDisplay() {
  document.getElementById('dateDisplay').textContent = formatDisplayDate(currentDate);
}

function setFilter(job) {
  currentFilter = job;
  renderParties();
}

function setTimeFilter(time) {
  currentTimeFilter = time;
  renderParties();
}


function buildJobChips() {
  const select = document.getElementById('jobFilter');
  const totalVacant = allParties.filter(p => (p.vacancies?.total || 0) > 0).length;
  let html = `<option value="">ì „ì²´ (${totalVacant})</option>`;
  Object.entries(JOB_INFO).forEach(([key, info]) => {
    const count = allParties.reduce((sum, p) => sum + (p.vacancies?.[key] || 0), 0);
    const countStr = count > 0 ? ` (${count})` : '';
    html += `<option value="${key}"${currentFilter === key ? ' selected' : ''}>${info.kr}${countStr}</option>`;
  });
  select.innerHTML = html;
}

function buildTimeChips() {
  const times = [...new Set(allParties.map(p => p.time_slot))].sort();
  const select = document.getElementById('timeFilter');
  let html = `<option value="">ì „ì²´ ì‹œê°„</option>`;
  times.forEach(t => {
    const timeParties = allParties.filter(p => p.time_slot === t);
    const vacantCount = timeParties.reduce((sum, p) => sum + (p.vacancies?.total || 0), 0);
    const countStr = vacantCount > 0 ? ` (${vacantCount})` : '';
    html += `<option value="${t}"${currentTimeFilter === t ? ' selected' : ''}>${t}${countStr}</option>`;
  });
  select.innerHTML = html;
}

let retryCount = 0;
const MAX_RETRY = 3;
let isLoading = false;

async function loadParties(isRetry = false) {
  if (isLoading && !isRetry) return;
  isLoading = true;
  refreshCountdown = 30;

  const dateStr = formatDate(currentDate);
  const includeComplete = document.getElementById('includeComplete').checked;

  // ì²« ë¡œë“œê°€ ì•„ë‹ˆë©´ ê¸°ì¡´ ë°ì´í„° ìœ ì§€ (ë¹ˆ í™”ë©´ ë°©ì§€)
  const isFirstLoad = allParties.length === 0 && !isRetry;
  if (isFirstLoad) {
    document.getElementById('content').innerHTML =
      '<div class="loading"><div class="spinner"></div><div style="color: var(--text-dim);">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div></div>';
  }

  try {
    const resp = await fetch(apiUrl('/api/party/vacancy?') + new URLSearchParams({
      date: dateStr,
      include_complete: includeComplete ? '1' : '0'
    }), { signal: AbortSignal.timeout(8000) });
    const data = await resp.json();

    retryCount = 0;
    if (data.success) {
      allParties = data.parties || [];
      buildJobChips();
      buildTimeChips();
      renderParties();
    } else {
      allParties = [];
      buildJobChips();
      buildTimeChips();
      renderParties();
    }
  } catch (err) {
    console.error('Load error:', err);
    if (retryCount < MAX_RETRY) {
      retryCount++;
      const delay = retryCount * 2000;
      // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í™”ë©´ ìœ ì§€, ì—†ì„ ë•Œë§Œ ì¬ì—°ê²° í‘œì‹œ
      if (allParties.length === 0) {
        document.getElementById('content').innerHTML =
          `<div class="empty-state"><div class="empty-state-icon">&#x1F504;</div><h3>ì¬ì—°ê²° ì¤‘... (${retryCount}/${MAX_RETRY})</h3></div>`;
      }
      setTimeout(() => loadParties(true), delay);
      isLoading = false;
      return;
    }
    // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€
    if (allParties.length === 0) {
      const isLocal = !SERVER_URL && location.protocol !== 'file:';
      const msg = isLocal
        ? 'ì„œë²„ì— ì¼ì‹œì ìœ¼ë¡œ ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìë™ìœ¼ë¡œ ì¬ì‹œë„í•©ë‹ˆë‹¤.'
        : 'ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒë‹¨ì—ì„œ ì„œë²„ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
      document.getElementById('content').innerHTML =
        `<div class="empty-state"><div class="empty-state-icon">&#x26A0;</div><h3>ì—°ê²° ì˜¤ë¥˜</h3><p>${msg}</p></div>`;
    }
    document.getElementById('serverStatus').className = 'server-status err';
    retryCount = 0;
  }

  isLoading = false;
  checkServerStatus();
}

function renderParties() {
  partyDataMap = {};
  const container = document.getElementById('content');
  let filtered = allParties;

  if (currentFilter) {
    filtered = filtered.filter(p => (p.vacancies?.[currentFilter] || 0) > 0);
  }
  if (currentTimeFilter) {
    filtered = filtered.filter(p => p.time_slot === currentTimeFilter);
  }
  if (mySearchName) {
    const searchName = mySearchName.toLowerCase();
    filtered = filtered.filter(p => {
      const jobs = ['warrior', 'rogue', 'mage', 'cleric', 'taoist'];
      return jobs.some(job => {
        const slots = p[`${job}_slots`] || [];
        return slots.some(s => s && s.toLowerCase().includes(searchName));
      });
    });
  }

  if (filtered.length === 0) {
    const filterName = currentFilter ? JOB_INFO[currentFilter].kr : '';
    let emptyMsg = 'í•´ë‹¹ ë‚ ì§œì— íŒŒí‹° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    if (mySearchName) {
      emptyMsg = `"${mySearchName}" ë‹˜ì´ ì°¸ì—¬ì¤‘ì¸ íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.`;
    } else if (filterName) {
      emptyMsg = filterName + ' ë¹ˆìë¦¬ê°€ ìˆëŠ” íŒŒí‹°ê°€ ì—†ìŠµë‹ˆë‹¤.';
    }
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">&#x1F50D;</div>
        <h3>íŒŒí‹° ì—†ìŒ</h3>
        <p>${emptyMsg}</p>
      </div>
    `;
    return;
  }

  // Group by time_slot
  const groups = {};
  filtered.forEach(p => {
    const ts = p.time_slot || 'ë¯¸ì •';
    if (!groups[ts]) groups[ts] = [];
    groups[ts].push(p);
  });

  const sortedTimes = Object.keys(groups).sort();
  let html = '';

  sortedTimes.forEach(time => {
    const parties = groups[time];
    const vacantCount = parties.filter(p => (p.vacancies?.total || 0) > 0).length;

    html += `
      <div class="time-group">
        <div class="time-header">
          <span class="time-badge">${time}</span>
          <span class="time-count">${parties.length}ê°œ íŒŒí‹°${vacantCount > 0 ? ` &middot; ${vacantCount}ê°œ ë¹ˆìë¦¬` : ''}</span>
        </div>
        <div class="party-grid">
    `;

    parties.forEach(p => {
      html += renderPartyCard(p);
    });

    html += '</div></div>';
  });

  container.innerHTML = html;
}

function renderPartyCard(party) {
  const loc = party.location || 'ë¯¸ì •';
  const locIcon = Object.entries(LOCATION_ICONS).find(([k]) => loc.includes(k));
  const icon = locIcon ? locIcon[1] : '&#x1F4CD;';
  const isComplete = party.is_complete;
  const sender = party.organizer || (party.sender_name ? party.sender_name.split('/')[0] : '');
  const vacancies = party.vacancies || {};

  // Vacancy tags
  let vacancyTags = '';
  Object.entries(JOB_INFO).forEach(([key, info]) => {
    const count = vacancies[key] || 0;
    if (count > 0) {
      vacancyTags += `<span class="vacancy-tag ${key}">${info.kr} ${count}ìë¦¬</span>`;
    }
  });

  // Slot rows
  let slotRows = '';
  const jobs = ['warrior', 'rogue', 'mage', 'cleric', 'taoist'];
  jobs.forEach(job => {
    const slots = party[`${job}_slots`] || [];
    if (slots.length === 0) return;

    const info = JOB_INFO[job];
    let slotsHtml = '';
    slots.forEach(s => {
      if (s === '') {
        slotsHtml += `<span class="slot empty ${job}">ëª¨ì§‘ì¤‘</span>`;
      } else {
        const isMe = mySearchName && s.toLowerCase().includes(mySearchName.toLowerCase());
        slotsHtml += `<span class="slot filled${isMe ? ' my-slot' : ''}">${s}</span>`;
      }
    });

    slotRows += `
      <div class="slot-row">
        <span class="slot-job ${job}">${info.kr}</span>
        <div class="slot-list">${slotsHtml}</div>
      </div>
    `;
  });

  // Requirements
  let reqHtml = '';
  const reqs = party.requirements || {};
  if (typeof reqs === 'object' && Object.keys(reqs).length > 0) {
    reqHtml = '<div class="requirements">';
    Object.entries(reqs).forEach(([job, req]) => {
      reqHtml += `<div class="req-item"><strong>${job}</strong>: ${req}</div>`;
    });
    reqHtml += '</div>';
  }

  const cardId = `party-${party.id || Math.random().toString(36).slice(2)}`;
  partyDataMap[cardId] = party;

  // ë‚´ íŒŒí‹° ì—¬ë¶€ í™•ì¸
  let isMyParty = false;
  if (mySearchName) {
    const name = mySearchName.toLowerCase();
    isMyParty = jobs.some(job => {
      const slots = party[`${job}_slots`] || [];
      return slots.some(s => s && s.toLowerCase() === name);
    });
  }

  return `
    <div class="party-card${isComplete ? ' complete' : ''}${isMyParty ? ' my-party' : ''}">
      <div class="card-top">
        <div class="card-location">
          <div class="location-icon">${icon}</div>
          <div>
            <div class="location-name">${loc} <span class="my-party-badge">ì°¸ì—¬ì¤‘</span></div>
            ${party.party_name ? `<div class="party-name">${party.party_name}</div>` : ''}
          </div>
        </div>
        <div class="card-meta">
          ${sender ? `<div class="card-sender">@${sender}</div>` : ''}
          ${party.updated_at ? `<div class="card-updated">${formatTimeAgo(party.updated_at)}</div>` : ''}
        </div>
      </div>
      ${vacancyTags ? `<div class="vacancy-summary">${vacancyTags}</div>` : ''}
      <div class="slot-rows">${slotRows}</div>
      ${reqHtml}
      <div class="card-actions">
        <button class="copy-btn" onclick="copyPartyTemplate(this, '${cardId}')">ğŸ“‹ êµ¬ì¸ê¸€ ë³µì‚¬</button>
        <span class="copy-hint">ì¹´ì¹´ì˜¤í†¡ì— ë¶™ì—¬ë„£ê¸° í•˜ì„¸ìš”</span>
      </div>
    </div>
  `;
}

function formatTimeAgo(dateStr) {
  if (!dateStr) return '';
  const d = new Date(dateStr);
  const now = new Date();
  const diff = Math.floor((now - d) / 1000);
  if (diff < 60) return 'ë°©ê¸ˆ';
  if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
  if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
  return `${Math.floor(diff / 86400)}ì¼ ì „`;
}

// â”€â”€ Blank template copy â”€â”€
let blankTemplateText = '';

async function loadBlankTemplate() {
  try {
    const url = SERVER_URL ? apiUrl('/party-template.txt') : '/party-template.txt';
    const resp = await fetch(url);
    if (resp.ok) blankTemplateText = await resp.text();
  } catch {}
  if (!blankTemplateText) {
    blankTemplateText = [
      'â˜…ì¥ì†Œ íŒŒí‹°ëª…â˜…',
      '#ë°ë¹Œ ì¡°ê±´ì…ë ¥',
      '#ë„ì  ì¡°ê±´ì…ë ¥',
      '#ë„ê°€ ì¡°ê±´ì…ë ¥',
      '#ë²•ì‚¬ ì¡°ê±´ì…ë ¥',
      '#ì§ì ì¡°ê±´ì…ë ¥',
      '',
      'ë‚ ì§œ(ìš”ì¼) #00:00~00:00 (ì¥ì†Œ)',
      'ì „ì‚¬ : [][]',
      'ë„ì  : [][]',
      'ë„ê°€ : [][]',
      'ë²•ì‚¬ : [][]',
      'ì§ì : [][][]',
      '',
      '@ì•„ì´ë””'
    ].join('\n');
  }
}

async function copyBlankTemplate(btn) {
  if (!blankTemplateText) await loadBlankTemplate();
  try {
    await navigator.clipboard.writeText(blankTemplateText);
  } catch {
    const ta = document.createElement('textarea');
    ta.value = blankTemplateText;
    ta.style.cssText = 'position:fixed;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }
  btn.textContent = 'âœ… ë³µì‚¬ë¨!';
  btn.classList.add('copied');
  setTimeout(() => {
    btn.textContent = 'ğŸ“ ê¸°ë³¸ì–‘ì‹ ë³µì‚¬';
    btn.classList.remove('copied');
  }, 2000);
}

// â”€â”€ My party search â”€â”€
function searchMyParty() {
  const input = document.getElementById('myNameInput');
  const name = input.value.trim();
  if (!name) return;
  mySearchName = name;
  localStorage.setItem('myCharName', name);
  document.getElementById('mySearchClear').classList.add('show');
  renderParties();
}

function clearMySearch() {
  mySearchName = '';
  document.getElementById('myNameInput').value = '';
  document.getElementById('mySearchClear').classList.remove('show');
  renderParties();
}

// â”€â”€ Copy party template â”€â”€
// íŒŒí‹° ë°ì´í„°ì—ì„œ ì§ì ‘ êµ¬ì¸ê¸€ ìƒì„± (ì‹¤ì œ ìŠ¤í™/ì¡°ê±´ í¬í•¨)
function generatePartyTemplate(party) {
  const loc = party.location || '';
  const time = party.time_slot || '';

  // ë‚ ì§œ: 2/7(ê¸ˆ)
  const d = currentDate;
  const month = d.getMonth() + 1;
  const day = d.getDate();
  const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
  const dateStr = `${month}/${day}(${dayNames[d.getDay()]})`;

  const lines = [];

  // â˜… íƒ€ì´í‹€ â˜…
  const titleParts = [loc, party.party_name].filter(Boolean).join(' ');
  if (titleParts) lines.push(`â˜…${titleParts}â˜…`);

  // # ìŠ¤í™ ì¡°ê±´ (íŒŒí‹° ë°ì´í„°ì—ì„œ ê°€ì ¸ì˜´)
  const reqs = party.requirements || {};
  if (typeof reqs === 'object' && Object.keys(reqs).length > 0) {
    Object.entries(reqs).forEach(([job, req]) => {
      lines.push(`#${job} ${req}`);
    });
  }

  // ë¹ˆ ì¤„ + ë‚ ì§œ/ì‹œê°„
  if (lines.length > 0) lines.push('');
  const timePart = time ? ` #${time}` : '';
  const locPart = loc ? ` (${loc})` : '';
  lines.push(`${dateStr}${timePart}${locPart}`);

  // ì§ì—… ìŠ¬ë¡¯: ì „ì‚¬ : [ë‹‰ë„¤ì„][ë‹‰ë„¤ì„][]
  const jobs = ['warrior', 'rogue', 'mage', 'cleric', 'taoist'];
  jobs.forEach(job => {
    const slots = party[`${job}_slots`] || [];
    if (slots.length === 0) return;
    const jobKr = JOB_INFO[job].kr;
    const slotStr = slots.map(s => s === '' ? '[]' : `[${s}]`).join('');
    lines.push(`${jobKr} : ${slotStr}`);
  });

  // @íŒŒí‹°ì¥
  const organizer = party.organizer || (party.sender_name ? party.sender_name.split('/')[0] : '');
  lines.push('');
  lines.push(`@${organizer || 'ì•„ì´ë””'}`);

  return lines.join('\n');
}

async function copyPartyTemplate(btn, cardId) {
  const party = partyDataMap[cardId];
  if (!party) return;

  const text = generatePartyTemplate(party);

  try {
    await navigator.clipboard.writeText(text);
  } catch {
    // Fallback for older browsers
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;opacity:0';
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  }

  btn.textContent = 'âœ… ë³µì‚¬ë¨!';
  btn.classList.add('copied');
  setTimeout(() => {
    btn.textContent = 'ğŸ“‹ êµ¬ì¸ê¸€ ë³µì‚¬';
    btn.classList.remove('copied');
  }, 2000);
}

// Auto refresh
function startRefreshTimer() {
  if (refreshInterval) clearInterval(refreshInterval);
  refreshInterval = setInterval(() => {
    refreshCountdown--;
    document.getElementById('refreshTimer').textContent = `${refreshCountdown}s`;
    if (refreshCountdown <= 0) {
      loadParties();
    }
  }, 1000);
}

// Init
initServerUrl();
updateDateDisplay();
loadParties();
checkServerStatus();
startRefreshTimer();

// Restore saved character name
const savedName = localStorage.getItem('myCharName');
if (savedName) {
  document.getElementById('myNameInput').value = savedName;
  mySearchName = savedName;
  document.getElementById('mySearchClear').classList.add('show');
}

// Enter key handlers
document.getElementById('serverUrl').addEventListener('keydown', e => {
  if (e.key === 'Enter') connectServer();
});
document.getElementById('myNameInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') searchMyParty();
});
</script>
</body>
</html>

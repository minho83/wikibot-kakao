# 어둠의전설 카카오톡 챗봇

어둠의전설(LOD) 게임 데이터베이스 검색, 거래/파티 관리, 닉네임 감지 등을 지원하는 카카오톡 챗봇입니다.

## 아키텍처

```
┌─────────────────┐      ┌─────────────────┐
│ iris-kakao-bot  │ ───▶ │    wikibot      │
│   (Python)      │      │   (Node.js)     │
│                 │      │                 │
│ - 카카오톡 연동  │      │ - API 서버      │
│ - 명령어 처리    │      │ - DB 관리       │
│ - 메시지 전송    │      │ - 데이터 파싱   │
└─────────────────┘      └─────────────────┘
```

## 주요 기능

### 검색 기능
- **아이템/스킬/마법 검색**: SQLite DB 기반 퍼지 검색 (초성, 오타 지원)
- **게시판 검색**: LOD 커뮤니티 게시판 키워드 검색
- **AI 검색**: RAG 기반 질의응답

### 공지/업데이트
- **공지사항 조회**: 넥슨 LOD 공지 게시판 파싱 및 DB 저장
- **업데이트 내역 조회**: 넥슨 LOD 업데이트 게시판 파싱 및 DB 저장
- **자동 알림 스케줄러**: 공지(화 17:05), 업데이트(수 17:00, 목 10:00) 자동 체크

### 거래 시스템
- **거래글 수집**: 지정된 방의 거래 메시지 자동 수집
- **시세 조회**: `!가격 [아이템명]` 으로 최근 시세 확인
- **거래방 설정**: 수집 방/조회 방 분리 관리

### 파티 모집
- **파티글 수집**: 지정된 방의 파티 모집 메시지 자동 파싱
- **빈자리 조회**: `!파티 [날짜] [직업]` 으로 빈자리 있는 파티 조회
- **자동 파싱**: 날짜, 시간, 장소, 직업별 슬롯 자동 추출

### 닉네임 감지
- **닉네임 변경 감지**: 오픈채팅방 닉네임 변경 이력 추적
- **입퇴장 기록**: 멤버 입퇴장 이벤트 로깅
- **이력 조회**: 특정 사용자의 닉네임 변경 이력 확인

## 사용 가능한 명령어

### 일반 명령어

| 명령어 | 설명 | 예시 |
|--------|------|------|
| `!아이템 [이름]` | 아이템 검색 | `!아이템 오리하르콘` |
| `!스킬 [이름]` | 스킬/마법 검색 | `!스킬 메테오` |
| `!검색 [키워드]` | 통합 검색 | `!검색 발록` |
| `!현자 [질문]` | AI 질의응답 | `!현자 백유 사냥법` |
| `!공지` | 최신 정기점검 공지 | `!공지` |
| `!업데이트` | 최신 업데이트 내역 | `!업데이트` |

### 거래 명령어

| 명령어 | 설명 | 예시 |
|--------|------|------|
| `!가격 [아이템]` | 시세 조회 | `!가격 암흑목걸이` |
| `!가격설정 목록` | 설정된 거래방 목록 | - |
| `!가격설정 수집` | 현재 방을 수집 방으로 설정 | - |
| `!가격설정 추가` | 현재 방을 조회 방으로 추가 | - |

### 파티 명령어

| 명령어 | 설명 | 예시 |
|--------|------|------|
| `!파티` | 오늘 빈자리 파티 목록 | `!파티` |
| `!파티 [직업]` | 특정 직업 빈자리 | `!파티 도가` |
| `!파티 [날짜]` | 특정 날짜 파티 | `!파티 2/6`, `!파티 내일` |
| `!파티 [날짜] [직업]` | 날짜 + 직업 필터 | `!파티 내일 전사` |
| `!파티설정 목록` | 설정된 파티방 목록 | - |
| `!파티설정 수집` | 현재 방을 수집 방으로 설정 | - |

### 관리자 명령어

| 명령어 | 설명 |
|--------|------|
| `!관리자등록` | 최초 관리자 등록 |
| `!서버재시작` | 서버 재배포 |
| `!방확인` | 현재 방 ID 확인 |
| `!닉변감지 추가/제거/목록` | 닉변 감지 방 설정 |
| `!닉변이력 [방ID]` | 닉변 이력 조회 |
| `!시세정리` | 가격 데이터 정리 |

## 배포

### GitHub Actions 자동 배포

```
iris-kakao-bot 푸시 → wikibot-kakao Deploy 트리거 → 서버 배포
```

1. `iris-kakao-bot` 레포에 푸시
2. GitHub Action이 `wikibot-kakao` 배포 트리거
3. Self-hosted runner가 `deploy.sh` 실행

### 수동 배포

```bash
# 서버에서 직접 실행
cd ~/wikibot-kakao && ./deploy.sh --force
```

### 봇 명령어로 배포

카카오톡에서 `!서버재시작` 명령어 실행 (관리자 전용)
- 트리거 파일 생성 → 호스트 cron이 1분 내 감지 → deploy.sh 실행

## Docker 구성

### wikibot-server (Node.js)
```bash
docker run -d \
  --name wikibot-server \
  -p 8100:3000 \
  -v ~/wikibot-data/nickname.db:/app/nickname.db \
  -v ~/wikibot-data/notice.db:/app/notice.db \
  -v ~/wikibot-data/trade.db:/app/trade.db \
  -v ~/wikibot-data/party.db:/app/party.db \
  -v ~/wikibot-kakao/LOD_DB:/app/LOD_DB \
  wikibot-kakao
```

### iris-bot-server (Python)
```bash
docker run -d \
  --name iris-bot-server \
  -p 5000:5000 \
  -v ~/iris-kakao-bot/bot-server:/app \
  iris-bot
```

## 데이터베이스

| DB 파일 | 용도 |
|---------|------|
| `nickname.db` | 닉네임 변경 이력, 감시 방 설정, 관리자 |
| `notice.db` | 공지/업데이트 기록 |
| `trade.db` | 거래 메시지, 거래방 설정 |
| `party.db` | 파티 모집글, 파티방 설정 |

DB 파일은 `~/wikibot-data/`에 저장되며 Docker 볼륨으로 마운트됩니다.

## 프로젝트 구조

```
wikibot-kakao/
├── src/
│   ├── index.js              # 서버 진입점, 라우팅
│   ├── controllers/
│   │   └── nicknameController.js
│   └── services/
│       ├── searchService.js      # 아이템/스킬 검색
│       ├── noticeService.js      # 공지/업데이트
│       ├── communityService.js   # 게시판 검색
│       ├── nicknameService.js    # 닉네임 감지
│       ├── tradeService.js       # 거래 시스템
│       └── partyService.js       # 파티 모집
├── iris-kakao-bot/           # 카카오톡 봇 (서브모듈)
│   └── app.py
├── deploy.sh                 # 배포 스크립트
└── Dockerfile
```

## 환경 변수

| 변수 | 설명 | 기본값 |
|------|------|--------|
| `PORT` | 서버 포트 | `3000` |
| `IRIS_URL` | Iris 서버 주소 | `http://192.168.0.80:3000` |
| `WIKIBOT_URL` | wikibot 서버 주소 | `http://localhost:8100` |

## 라이선스

MIT
